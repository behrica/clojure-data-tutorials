
---
format:
  html: {toc: true, toc-depth: 4, theme: cosmo, output-file: index.html}
fontsize: 0.9em
code-block-background: true
include-in-header: {text: '<link rel = "icon" href = "data:," />'}

---
<style></style><style>.printedClojure .sourceCode {
  background-color: transparent;
  border-style: none;
}
</style><style>.clay-limit-image-width .clay-image {max-width: 100%}
</style>
<script src="index_files/md-default13.js" type="text/javascript"></script><script src="index_files/md-default14.js" type="text/javascript"></script>

```{=html}
<table><tr><td>This is part of the Scicloj <a href="https://scicloj.github.io/clojure-data-scrapbook/">Clojure Data Scrapbook</a>.</td><a href="https://scicloj.github.io/clojure-data-scrapbook/"><img align="left" alt="SciCloj logo" src="https://scicloj.github.io/sci-cloj-logo-transparent.png" width="40" /></a></tr></table>
```



# Clay & Noj demo: image processing


::: {.sourceClojure}
```clojure
(ns index
  (:require [tech.v3.libs.buffered-image :as bufimg]
            [tech.v3.datatype :as dtype]
            [tech.v3.tensor :as tensor]
            [tech.v3.datatype.functional :as fun]
            [scicloj.kindly.v4.kind :as kind]))
```
:::



::: {.sourceClojure}
```clojure
(kind/hiccup [:style "img {max-width: 100%}"])
```
:::



```{=html}
<style>img {max-width: 100%}</style>
```



::: {.sourceClojure}
```clojure
(kind/video {:youtube-id "fd4kjlws6Ts"})
```
:::



```{=html}
<iframe allowfullscreen="allowfullscreen" src="https://www.youtube.com/embed/fd4kjlws6Ts"></iframe>
```



## Arithmetic


::: {.sourceClojure}
```clojure
(+ 1 2)
```
:::



::: {.printedClojure}
```clojure
3

```
:::



## Loading data


::: {.sourceClojure}
```clojure
(defonce raw-image
  (bufimg/load
   "https://upload.wikimedia.org/wikipedia/commons/1/1e/Gay_head_cliffs_MV.JPG"))
```
:::



::: {.sourceClojure}
```clojure
(type raw-image)
```
:::



::: {.printedClojure}
```clojure
java.awt.image.BufferedImage

```
:::



::: {.sourceClojure}
```clojure
(bufimg/image-type raw-image)
```
:::



::: {.printedClojure}
```clojure
:byte-bgr

```
:::



## Displaying images


::: {.sourceClojure}
```clojure
raw-image
```
:::


::: {.clay-image}

```{=html}
<img src="index_files/0.png" />
```

:::



## Tensors


::: {.sourceClojure}
```clojure
(defonce raw-tensor
  (-> raw-image
      bufimg/as-ubyte-tensor))
```
:::



::: {.sourceClojure}
```clojure
(dtype/shape raw-tensor)
```
:::



::: {.printedClojure}
```clojure
[1478 2006 3]

```
:::



## Processing


::: {.sourceClojure}
```clojure
(kind/fragment
 [raw-image
  (-> raw-tensor
      (fun/* 0.5)
      (bufimg/tensor->image :byte-bgr))])
```
:::


::: {.clay-image}

```{=html}
<img src="index_files/0.png" />
```

:::


::: {.clay-image}

```{=html}
<img src="index_files/1.png" />
```

:::



## Hiccup


::: {.sourceClojure}
```clojure
(kind/hiccup
 [:div
  [:h3 "raw image"]
  raw-image
  [:h3 "darkened image"]
  (-> raw-tensor
      (fun/* 0.5)
      (bufimg/tensor->image :byte-bgr))])
```
:::



```{=html}
<div><h3>raw image</h3><img class="clay-image" src="index_files/0.png" /><h3>darkened image</h3><img class="clay-image" src="index_files/2.png" /></div>
```



## Colour channels


::: {.sourceClojure}
```clojure
(def colour-channels
  (-> raw-tensor
      (tensor/slice-right 1)))
```
:::



::: {.sourceClojure}
```clojure
(def blue (colour-channels 0))
```
:::



::: {.sourceClojure}
```clojure
(def green (colour-channels 1))
```
:::



::: {.sourceClojure}
```clojure
(def red (colour-channels 2))
```
:::



::: {.sourceClojure}
```clojure
(count colour-channels)
```
:::



::: {.printedClojure}
```clojure
3

```
:::



::: {.sourceClojure}
```clojure
(mapv dtype/shape colour-channels)
```
:::



::: {.printedClojure}
```clojure
[[1478 2006] [1478 2006] [1478 2006]]

```
:::



::: {.sourceClojure}
```clojure
(-> (tensor/compute-tensor (dtype/shape raw-tensor)
                           (fn [i j k]
                             (if (= k 2)
                               (raw-tensor i j k)
                               0))
                           :uint8)
    (bufimg/tensor->image :byte-bgr))
```
:::


::: {.clay-image}

```{=html}
<img src="index_files/3.png" />
```

:::



## Conditioned processing


::: {.sourceClojure}
```clojure
(-> (tensor/compute-tensor (dtype/shape raw-tensor)
                           (fn [i j k]
                             (*
                              (raw-tensor i j k)
                              (if (> (green i j)
                                     (blue i j))
                                0.3
                                1)))
                           :uint8)
    (bufimg/tensor->image :byte-bgr))
```
:::


::: {.clay-image}

```{=html}
<img src="index_files/4.png" />
```

:::



::: {.sourceClojure}
```clojure
(-> (tensor/compute-tensor (dtype/shape raw-tensor)
                           (fn [i j k]
                             (*
                              (raw-tensor i j k)
                              (if (> (green i j)
                                     (* 1.2 (blue i j)))
                                0.3
                                1)))
                           :uint8)
    (bufimg/tensor->image :byte-bgr))
```
:::


::: {.clay-image}

```{=html}
<img src="index_files/5.png" />
```

:::



::: {.sourceClojure}
```clojure
(->> [0.7 0.8 0.9 1 1.1 1.2 1.3]
     (map (fn [factor]
            [factor
             (-> (tensor/compute-tensor (dtype/shape raw-tensor)
                                        (fn [i j k]
                                          (*
                                           (raw-tensor i j k)
                                           (if (> (green i j)
                                                  (* factor (blue i j)))
                                             0.3
                                             1)))
                                        :uint8)
                 (bufimg/tensor->image :byte-bgr))])))
```
:::



```{=html}
<div><p>(</p><div style="margin-left:10%;width:110%;"><div><p>[</p><div style="margin-left:10%;width:110%;"><div><pre><code class="sourceCode language-clojure printed-clojure">0.7
</code></pre></div><img class="clay-image" src="index_files/6.png" /></div><p>]</p></div><div><p>[</p><div style="margin-left:10%;width:110%;"><div><pre><code class="sourceCode language-clojure printed-clojure">0.8
</code></pre></div><img class="clay-image" src="index_files/7.png" /></div><p>]</p></div><div><p>[</p><div style="margin-left:10%;width:110%;"><div><pre><code class="sourceCode language-clojure printed-clojure">0.9
</code></pre></div><img class="clay-image" src="index_files/8.png" /></div><p>]</p></div><div><p>[</p><div style="margin-left:10%;width:110%;"><div><pre><code class="sourceCode language-clojure printed-clojure">1
</code></pre></div><img class="clay-image" src="index_files/9.png" /></div><p>]</p></div><div><p>[</p><div style="margin-left:10%;width:110%;"><div><pre><code class="sourceCode language-clojure printed-clojure">1.1
</code></pre></div><img class="clay-image" src="index_files/10.png" /></div><p>]</p></div><div><p>[</p><div style="margin-left:10%;width:110%;"><div><pre><code class="sourceCode language-clojure printed-clojure">1.2
</code></pre></div><img class="clay-image" src="index_files/11.png" /></div><p>]</p></div><div><p>[</p><div style="margin-left:10%;width:110%;"><div><pre><code class="sourceCode language-clojure printed-clojure">1.3
</code></pre></div><img class="clay-image" src="index_files/12.png" /></div><p>]</p></div></div><p>)</p></div>
```



```{=html}
<div style="background-color:grey;height:2px;width:100%;"></div>
```



```{=html}
<div><pre><small><small>source: <a href="https://github.com/scicloj/clojure-data-scrapbook/blob/main/projects/visual-tools/clay-cider-demo-20231217/notebooks/index.clj">projects/visual-tools/clay-cider-demo-20231217/notebooks/index.clj</a></small></small></pre></div>
```
