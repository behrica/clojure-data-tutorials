
---
format:
  html: {toc: true, toc-depth: 4, theme: cosmo, output-file: index.html}
code-block-background: true
include-in-header: {text: '<link rel = "icon" href = "data:," />'}

---
<style></style><style>.printedClojure .sourceCode {
  background-color: transparent;
  border-style: none;
}
</style><style>.clay-limit-image-width .clay-image {max-width: 100%}
</style>
<script src="index_files/md-default12.js" type="text/javascript"></script><script src="index_files/md-default13.js" type="text/javascript"></script><script src="index_files/vega14.js" type="text/javascript"></script><script src="index_files/vega15.js" type="text/javascript"></script><script src="index_files/vega16.js" type="text/javascript"></script>

```{=html}
<table><tr><td>This is part of the Scicloj <a href="https://scicloj.github.io/clojure-data-scrapbook/">Clojure Data Scrapbook</a>.</td><a href="https://scicloj.github.io/clojure-data-scrapbook/"><img align="left" alt="SciCloj logo" src="https://scicloj.github.io/sci-cloj-logo-transparent.png" width="40" /></a></tr></table>
```



# Chicago bikes - DRAFT

This page will be updated soon.


## Data sources:
- [Cyclistic bike share - Kaggle](https://www.kaggle.com/datasets/evangower/cyclistic-bike-share)
- [Cyclistic bike share - 2023 update - Kaggle](https://www.kaggle.com/datasets/godofoutcasts/cyclistic-bike-share-2023)
- [Chicago neighborhoods geojson by @blackmad](https://github.com/blackmad/neighborhoods/blob/master/chicago.geojson)



## Workflow


::: {.sourceClojure}
```clojure
(ns index
  (:require [tablecloth.api :as tc]
            [clojure.string :as str]
            [scicloj.noj.v1.vis.hanami :as hanami]
            [aerial.hanami.templates :as ht]
            [fastmath-clustering.core :as clustering]
            [scicloj.kindly.v4.kind :as kind]))
```
:::



::: {.sourceClojure}
```clojure
(defonce raw-trips
  (-> "data/kaggle-cyclistic/202304_divvy_tripdata.csv.gz"
      (tc/dataset {:key-fn keyword})))
```
:::



::: {.sourceClojure}
```clojure
(def coord-colnames
  [:start_lat :start_lng :end_lat :end_lng])
```
:::



::: {.sourceClojure}
```clojure
(def processed-trips
  (-> raw-trips
      (tc/map-columns :hour [:started_at]
                      (fn [s]
                        (-> s
                            (str/split #" ")
                            second
                            (str/split #":")
                            first)))
      (tc/select-rows (fn [row]
                        (->> coord-colnames
                             (map row)
                             (every? some?))))))
```
:::



::: {.sourceClojure}
```clojure
(delay
  (-> processed-trips
      (tc/group-by [:hour])
      (tc/aggregate {:n tc/row-count})
      (tc/order-by [:hour])))
```
:::


::: {.clay-dataset}
_unnamed [24 2]:

| :hour |    :n |
|-------|------:|
|    00 |  5093 |
|    01 |  3227 |
|    02 |  1871 |
|    03 |  1162 |
|    04 |   948 |
|    05 |  2801 |
|    06 |  8859 |
|    07 | 17058 |
|    08 | 22162 |
|    09 | 17299 |
|   ... |   ... |
|    13 | 24807 |
|    14 | 25866 |
|    15 | 30699 |
|    16 | 40338 |
|    17 | 46854 |
|    18 | 38245 |
|    19 | 27078 |
|    20 | 17231 |
|    21 | 14367 |
|    22 | 10810 |
|    23 |  7317 |


:::



::: {.sourceClojure}
```clojure
(defn hour-counts-plot [trips]
  (-> trips
      (tc/group-by [:hour])
      (tc/aggregate {:n tc/row-count})
      (hanami/plot ht/bar-chart
                   {:X :hour
                    :Y :n})))
```
:::



::: {.sourceClojure}
```clojure
(delay
  (hour-counts-plot processed-trips))
```
:::



```{=html}
<div><script>vegaEmbed(document.currentScript.parentElement, {"encoding":{"y":{"field":"n","type":"quantitative"},"x":{"field":"hour","type":"quantitative"}},"usermeta":{"embedOptions":{"renderer":"svg"}},"mark":{"type":"bar","tooltip":true},"width":400,"background":"floralwhite","height":300,"data":{"url":"index_files\/0.csv","format":{"type":"csv"}}});</script></div>
```



::: {.sourceClojure}
```clojure
(defn as-geo [vega-lite-spec]
  (-> vega-lite-spec
      (update :encoding update-keys (fn [k]
                                      (get {:x :latitude
                                            :y :longitude
                                            :x2 :latitude2
                                            :y2 :longitude2}
                                           k k)))
      (assoc :projection {:type :mercator})
      ;; to improve performance, we avoid rendering as SVG in this case:
      (dissoc :usermeta)))
```
:::



::: {.sourceClojure}
```clojure
(delay
  (-> processed-trips
      (tc/random 1000 {:seed 1})
      (hanami/plot ht/rule-chart
                   {:X :start_lat
                    :Y :start_lng
                    :X2 :end_lat
                    :Y2 :end_lng})
      as-geo))
```
:::



```{=html}
<div><script>vegaEmbed(document.currentScript.parentElement, {"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"latitude":{"field":"start_lat","type":"quantitative"},"longitude2":{"field":"end_lng","type":"quantitative"},"latitude2":{"field":"end_lat","type":"quantitative"}},"mark":"rule","width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300,"data":{"url":"index_files\/1.csv","format":{"type":"csv"}}});</script></div>
```



::: {.sourceClojure}
```clojure
(delay
  (-> processed-trips
      (tc/random 1000 {:seed 1})
      (hanami/plot ht/layer-chart
                   {:TITLE "Chicago bike trips"
                    :LAYER [{:data {:url "notebooks/data/chicago.geojson"
                                    :format {:type "topojson"}}
                             :mark {:type "geoshape"
                                    :filled false
                                    :clip true
                                    :opacity 0.3}}
                            (as-geo
                             (hanami/plot nil
                                          ht/rule-chart
                                          {:X :start_lat
                                           :Y :start_lng
                                           :X2 :end_lat
                                           :Y2 :end_lng
                                           :OPACITY 0.1}))]})))
```
:::



```{=html}
<div><script>vegaEmbed(document.currentScript.parentElement, {"usermeta":{"embedOptions":{"renderer":"svg"}},"width":400,"background":"floralwhite","title":{"text":"Chicago bike trips"},"layer":[{"data":{"url":"notebooks\/data\/chicago.geojson","format":{"type":"topojson"}},"mark":{"type":"geoshape","filled":false,"clip":true,"opacity":0.3}},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.1},"latitude":{"field":"start_lat","type":"quantitative"},"longitude2":{"field":"end_lng","type":"quantitative"},"latitude2":{"field":"end_lat","type":"quantitative"}},"mark":"rule","width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300}],"height":300,"data":{"url":"index_files\/1.csv","format":{"type":"csv"}}});</script></div>
```



::: {.sourceClojure}
```clojure
(def clustering
  (-> processed-trips
      (tc/select-columns coord-colnames)
      tc/rows
      (clustering/k-means 100)
      (dissoc :data)))
```
:::


A few clueters:


::: {.sourceClojure}
```clojure
(delay
  (-> processed-trips
      (tc/add-column :cluster (:clustering clustering))
      (tc/group-by [:cluster])
      (tc/without-grouping->
       (tc/order-by (fn [ds]
                      (-> ds :data tc/row-count))
                    :desc)
       (tc/head 5))
      (tc/aggregate {:n tc/row-count
                     :map (fn [trips]
                            [(-> trips
                                 (hanami/plot ht/layer-chart
                                              {:TITLE "Chicago bike trips"
                                               :LAYER [{:data {:url "notebooks/data/chicago.geojson"
                                                               :format {:type "topojson"}}
                                                        :mark {:type "geoshape"
                                                               :filled false
                                                               :clip true
                                                               :opacity 0.3}}
                                                       (as-geo
                                                        (hanami/plot nil
                                                                     ht/rule-chart
                                                                     {:X :start_lat
                                                                      :Y :start_lng
                                                                      :X2 :end_lat
                                                                      :Y2 :end_lng
                                                                      :OPACITY 0.01}))
                                                       (as-geo
                                                        (hanami/plot nil
                                                                     ht/point-chart
                                                                     {:X :start_lat
                                                                      :Y :start_lng
                                                                      :MCOLOR "purple"
                                                                      :OPACITY 0.01}))
                                                       (as-geo
                                                        (hanami/plot nil
                                                                     ht/point-chart
                                                                     {:X :end_lat
                                                                      :Y :end_lng
                                                                      :MCOLOR "green"
                                                                      :OPACITY 0.01}))]}))])
                     :hours (fn [trips]
                              [(hour-counts-plot trips)])})
      kind/table))
```
:::


::: {.clay-table}

```{=html}
<table class="table table-hover table-responsive"><thead><tr><th>cluster</th><th>n</th><th>map-0</th><th>hours-0</th></tr></thead><tbody><tr><td>79</td><td>12193</td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"usermeta":{"embedOptions":{"renderer":"svg"}},"width":400,"background":"floralwhite","title":{"text":"Chicago bike trips"},"layer":[{"data":{"url":"notebooks\/data\/chicago.geojson","format":{"type":"topojson"}},"mark":{"type":"geoshape","filled":false,"clip":true,"opacity":0.3}},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"},"longitude2":{"field":"end_lng","type":"quantitative"},"latitude2":{"field":"end_lat","type":"quantitative"}},"mark":"rule","width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"}},"mark":{"type":"circle","color":"purple","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"end_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"end_lat","type":"quantitative"}},"mark":{"type":"circle","color":"green","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300}],"height":300,"data":{"url":"index_files\/2.csv","format":{"type":"csv"}}});</script></div></td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"encoding":{"y":{"field":"n","type":"quantitative"},"x":{"field":"hour","type":"quantitative"}},"usermeta":{"embedOptions":{"renderer":"svg"}},"mark":{"type":"bar","tooltip":true},"width":400,"background":"floralwhite","height":300,"data":{"url":"index_files\/3.csv","format":{"type":"csv"}}});</script></div></td></tr><tr><td>21</td><td>11476</td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"usermeta":{"embedOptions":{"renderer":"svg"}},"width":400,"background":"floralwhite","title":{"text":"Chicago bike trips"},"layer":[{"data":{"url":"notebooks\/data\/chicago.geojson","format":{"type":"topojson"}},"mark":{"type":"geoshape","filled":false,"clip":true,"opacity":0.3}},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"},"longitude2":{"field":"end_lng","type":"quantitative"},"latitude2":{"field":"end_lat","type":"quantitative"}},"mark":"rule","width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"}},"mark":{"type":"circle","color":"purple","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"end_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"end_lat","type":"quantitative"}},"mark":{"type":"circle","color":"green","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300}],"height":300,"data":{"url":"index_files\/4.csv","format":{"type":"csv"}}});</script></div></td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"encoding":{"y":{"field":"n","type":"quantitative"},"x":{"field":"hour","type":"quantitative"}},"usermeta":{"embedOptions":{"renderer":"svg"}},"mark":{"type":"bar","tooltip":true},"width":400,"background":"floralwhite","height":300,"data":{"url":"index_files\/5.csv","format":{"type":"csv"}}});</script></div></td></tr><tr><td>32</td><td>11174</td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"usermeta":{"embedOptions":{"renderer":"svg"}},"width":400,"background":"floralwhite","title":{"text":"Chicago bike trips"},"layer":[{"data":{"url":"notebooks\/data\/chicago.geojson","format":{"type":"topojson"}},"mark":{"type":"geoshape","filled":false,"clip":true,"opacity":0.3}},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"},"longitude2":{"field":"end_lng","type":"quantitative"},"latitude2":{"field":"end_lat","type":"quantitative"}},"mark":"rule","width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"}},"mark":{"type":"circle","color":"purple","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"end_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"end_lat","type":"quantitative"}},"mark":{"type":"circle","color":"green","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300}],"height":300,"data":{"url":"index_files\/6.csv","format":{"type":"csv"}}});</script></div></td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"encoding":{"y":{"field":"n","type":"quantitative"},"x":{"field":"hour","type":"quantitative"}},"usermeta":{"embedOptions":{"renderer":"svg"}},"mark":{"type":"bar","tooltip":true},"width":400,"background":"floralwhite","height":300,"data":{"url":"index_files\/7.csv","format":{"type":"csv"}}});</script></div></td></tr><tr><td>49</td><td>10835</td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"usermeta":{"embedOptions":{"renderer":"svg"}},"width":400,"background":"floralwhite","title":{"text":"Chicago bike trips"},"layer":[{"data":{"url":"notebooks\/data\/chicago.geojson","format":{"type":"topojson"}},"mark":{"type":"geoshape","filled":false,"clip":true,"opacity":0.3}},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"},"longitude2":{"field":"end_lng","type":"quantitative"},"latitude2":{"field":"end_lat","type":"quantitative"}},"mark":"rule","width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"}},"mark":{"type":"circle","color":"purple","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"end_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"end_lat","type":"quantitative"}},"mark":{"type":"circle","color":"green","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300}],"height":300,"data":{"url":"index_files\/8.csv","format":{"type":"csv"}}});</script></div></td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"encoding":{"y":{"field":"n","type":"quantitative"},"x":{"field":"hour","type":"quantitative"}},"usermeta":{"embedOptions":{"renderer":"svg"}},"mark":{"type":"bar","tooltip":true},"width":400,"background":"floralwhite","height":300,"data":{"url":"index_files\/9.csv","format":{"type":"csv"}}});</script></div></td></tr><tr><td>13</td><td>10360</td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"usermeta":{"embedOptions":{"renderer":"svg"}},"width":400,"background":"floralwhite","title":{"text":"Chicago bike trips"},"layer":[{"data":{"url":"notebooks\/data\/chicago.geojson","format":{"type":"topojson"}},"mark":{"type":"geoshape","filled":false,"clip":true,"opacity":0.3}},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"},"longitude2":{"field":"end_lng","type":"quantitative"},"latitude2":{"field":"end_lat","type":"quantitative"}},"mark":"rule","width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"start_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"start_lat","type":"quantitative"}},"mark":{"type":"circle","color":"purple","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300},{"encoding":{"longitude":{"field":"end_lng","type":"quantitative"},"opacity":{"value":0.01},"latitude":{"field":"end_lat","type":"quantitative"}},"mark":{"type":"circle","color":"green","tooltip":true},"width":400,"background":"floralwhite","projection":{"type":"mercator"},"height":300}],"height":300,"data":{"url":"index_files\/10.csv","format":{"type":"csv"}}});</script></div></td><td><div><script>vegaEmbed(document.currentScript.parentElement, {"encoding":{"y":{"field":"n","type":"quantitative"},"x":{"field":"hour","type":"quantitative"}},"usermeta":{"embedOptions":{"renderer":"svg"}},"mark":{"type":"bar","tooltip":true},"width":400,"background":"floralwhite","height":300,"data":{"url":"index_files\/11.csv","format":{"type":"csv"}}});</script></div></td></tr></tbody></table>
```

:::



```{=html}
<div style="background-color:grey;height:2px;width:100%;"></div>
```



```{=html}
<div><pre><small><small>source: <a href="https://github.com/scicloj/clojure-data-scrapbook/blob/main/projects/geography/chicago-bikes/notebooks/index.clj">projects/geography/chicago-bikes/notebooks/index.clj</a></small></small></pre></div>
```
